(function(b){var a=function(d){var c=this;d=d||{};if(typeof d=="string"){d={elements:d}}this.sel=null;this.textSelection="";this.htmlSelection="";this.appId=b('meta[property="fb:app_id"]').attr("content")||b('meta[property="fb:app_id"]').attr("value");this.url2share=b('meta[property="og:url"]').attr("content")||b('meta[property="og:url"]').attr("value")||window.location.href;this.getSelectionText=function(j){var h="",k="";j=j||window.getSelection();if(j.rangeCount){var f=document.createElement("div");for(var g=0,e=j.rangeCount;g<e;++g){f.appendChild(j.getRangeAt(g).cloneContents())}k=f.textContent;h=f.innerHTML}c.textSelection=k;c.htmlSelection=h||k;return k};this.selectionDirection=function(f){var g=f||window.getSelection();var e=document.createRange();if(!g.anchorNode){return 0}e.setStart(g.anchorNode,g.anchorOffset);e.setEnd(g.focusNode,g.focusOffset);var h=(e.collapsed)?"backward":"forward";e.detach();return h};this.showPopunder=function(){c.popunder=c.popunder||document.getElementById("selectionSharerPopunder");var l=window.getSelection();var i=c.getSelectionText(l);if(l.isCollapsed||i.length<10||!i.match(/ /)){return c.hidePopunder()}if(c.popunder.classList.contains("fixed")){c.popunder.style.bottom=0;return c.popunder.style.bottom}var f=l.getRangeAt(0);var j=f.endContainer.parentNode;if(c.popunder.classList.contains("show")){if(Math.ceil(c.popunder.getBoundingClientRect().top)==Math.ceil(j.getBoundingClientRect().bottom)){return}return c.hidePopunder(c.showPopunder)}if(j.nextElementSibling){c.pushSiblings(j)}else{if(!c.placeholder){c.placeholder=document.createElement("div");c.placeholder.className="selectionSharerPlaceholder"}var k=window.getComputedStyle(j).marginBottom;c.placeholder.style.height=k;c.placeholder.style.marginBottom=(-2*parseInt(k,10))+"px";j.parentNode.insertBefore(c.placeholder)}var h=window.pageYOffset+j.getBoundingClientRect().bottom;c.popunder.style.top="45px";c.popunder.style.position="fixed";setTimeout(function(){if(c.placeholder){c.placeholder.classList.add("show")}c.popunder.classList.add("show")},0);function g(n,p,m){var o;return function(){var t=this,s=arguments;var r=function(){o=null;if(!m){n.apply(t,s)}};var q=m&&!o;clearTimeout(o);o=setTimeout(r,p);if(q){n.apply(t,s)}}}var e=g(function(){if(l.isCollapsed||i.length>10||i.match(/ /)){l.empty();return c.hidePopunder()}},50);window.addEventListener("scroll",e)};this.pushSiblings=function(e){while(e=e.nextElementSibling){e.classList.add("selectionSharer");e.classList.add("MoveDown")}};this.hidePopunder=function(e){e=e||function(){};if(c.popunder=="fixed"){c.popunder.style.bottom="-50px";return e()}c.popunder.classList.remove("show");if(c.placeholder){c.placeholder.classList.remove("show")}var f=document.getElementsByClassName("MoveDown");while(el=f[0]){el.classList.remove("MoveDown")}setTimeout(function(){if(c.placeholder){document.body.insertBefore(c.placeholder)}e()},600)};this.show=function(f){setTimeout(function(){var i=window.getSelection();var h=c.getSelectionText(i);if(!i.isCollapsed&&h&&h.length>10&&h.match(/ /)){var e=i.getRangeAt(0);var g=e.getBoundingClientRect().top-5;var l=g+c.getPosition().y-c.$popover.height();var k=0;if(f){k=f.pageX}else{var j=i.anchorNode.parentNode;k+=j.offsetWidth/2;do{k+=j.offsetLeft}while(j=j.offsetParent)}switch(c.selectionDirection(i)){case"forward":k-=c.$popover.width();break;case"backward":k+=c.$popover.width();break;default:return}c.$popover.removeClass("anim").css("top",l+10).css("left",k).show();setTimeout(function(){c.$popover.addClass("anim").css("top",l)},0)}},10)};this.hide=function(f){c.$popover.hide()};this.smart_truncate=function(g,h){if(!g||!g.length){return g}var f=g.length>h,e=f?g.substr(0,h-1):g;e=f?e.substr(0,e.lastIndexOf(" ")):e;return f?e+"...":e};this.getRelatedTwitterAccounts=function(){var g=[];var h=b('meta[name="twitter:creator"]').attr("content")||b('meta[name="twitter:creator"]').attr("value");if(h){g.push(h)}var j=document.getElementsByTagName("a");for(var f=0,e=j.length;f<e;f++){if(j[f].attributes.href&&typeof j[f].attributes.href.value=="string"){var k=j[f].attributes.href.value.match(/^https?:\/\/twitter\.com\/([a-z0-9_]{1,20})/i);if(k&&k.length>1&&["widgets","intent"].indexOf(k[1])==-1){g.push(k[1])}}}if(g.length>0){return g.join(",")}else{return""}};this.shareTwitter=function(l){l.preventDefault();var m="“"+c.smart_truncate(c.textSelection.trim(),114)+"”";var g="http://twitter.com/intent/tweet?text="+encodeURIComponent(m)+"&related="+c.relatedTwitterAccounts+"&url="+encodeURIComponent(window.location.href+"#sst");if(c.viaTwitterAccount&&m.length<(120-6-c.viaTwitterAccount.length)){g+="&via="+c.viaTwitterAccount}var f=640,i=440;var k=(screen.width/2)-(f/2);var j=(screen.height/2)-(i/2)-100;window.open(g,"share_twitter","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+f+", height="+i+", top="+j+", left="+k);c.hide();return true};this.shareFacebook=function(l){l.preventDefault();var m=c.htmlSelection.replace(/<p[^>]*>/ig,"\n").replace(/<\/p>|  /ig,"").trim();m=m.replace("&nbsp;"," ");m=m.replace(/(<([^>]+)>)/ig," ");var g="https://www.facebook.com/dialog/feed?app_id="+c.appId+"&display=popup&quote="+encodeURIComponent(m)+"&link="+encodeURIComponent(window.location.href+"#ssf")+"&href="+encodeURIComponent(window.location.href+"#ssf");var f=640,i=440;var k=(screen.width/2)-(f/2);var j=(screen.height/2)-(i/2)-100;window.open(g,"share_facebook","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+f+", height="+i+", top="+j+", left="+k);c.hide();return true};this.shareEmail=function(g){var h=c.textSelection.replace(/<p[^>]*>/ig,"\n").replace(/<\/p>|  /ig,"").trim();var f={};f.subject=encodeURIComponent("Quote from "+document.title);f.body=encodeURIComponent("“"+h+"”")+"%0D%0A%0D%0AFrom: "+document.title+"%0D%0A"+window.location.href+"#ssm";b(this).attr("href","mailto:?subject="+f.subject+"&body="+f.body);c.hide();return true};this.render=function(){var f='<div class="selectionSharer" id="selectionSharerPopover" style="position:absolute;">  <div id="selectionSharerPopover-inner">    <ul>      <li><a class="action tweet gtm-event" data-evt-category="Social Tools" data-evt-action="Selection Sharer | Desktop" data-evt-label="Twitter on '+window.location.pathname+'" href="" title="Share this selection on Twitter" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>      <li><a class="action facebook gtm-event" data-evt-category="Social Tools" data-evt-action="Selection Sharer | Desktop" data-evt-label="Facebook on '+window.location.pathname+'" href="" title="Share this selection on Facebook" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>      <li><a class="action email gtm-event" data-evt-category="Social Tools" data-evt-action="Selection Sharer | Desktop" data-evt-label="Emailed '+window.location.pathname+'" href="" title="Share this selection by email"><i class="fa fa-envelope" aria-hidden="true"></i></a></li>    </ul>  </div>  <div class="selectionSharerPopover-clip"><span class="selectionSharerPopover-arrow"></span></div></div>';var e='<div id="selectionSharerPopunder" class="selectionSharer">  <div id="selectionSharerPopunder-inner">    <ul>      <li><label><strong>Share this selection</strong></label></li>      <li><a class="action tweet gtm-event" data-evt-category="Social Tools" data-evt-action="Selection Sharer | Mobile" data-evt-label="Twitter on '+window.location.pathname+'" href="" title="Share this selection on Twitter" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>      <li><a class="action facebook gtm-event" data-evt-category="Social Tools" data-evt-action="Selection Sharer | Mobile" data-evt-label="Facebook on '+window.location.pathname+'" href="" title="Share this selection on Facebook" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>      <li><a class="action email gtm-event" data-evt-category="Social Tools" data-evt-action="Selection Sharer | Mobile" data-evt-label="Emailed on '+window.location.pathname+'" href="" title="Share this selection by email"><i class="fa fa-envelope" aria-hidden="true"></i></a></li>    </ul>  </div></div>';c.$popover=b(f);c.$popover.find("a.tweet").click(c.shareTwitter);c.$popover.find("a.facebook").click(c.shareFacebook);c.$popover.find("a.email").click(c.shareEmail);b("body").append(c.$popover);if(c.appId&&c.url2share){b(".selectionSharer a.facebook").css("display","inline-block")}c.$popunder=b(e);c.$popunder.find("a.tweet").click(c.shareTwitter);c.$popunder.find("a.facebook").click(c.shareFacebook);c.$popunder.find("a.email").click(c.shareEmail);b("body").append(c.$popunder);if(c.appId&&c.url2share){b(".selectionSharer a.facebook").css("display","inline-block")}};this.setElements=function(e){if(typeof e=="string"){e=b(e)}c.$elements=e instanceof b?e:b(e);c.$elements.mouseup(c.show).mousedown(c.hide).addClass("selectionShareable");c.$elements.bind("touchstart",function(f){c.isMobile=true});document.onselectionchange=c.selectionChanged};this.selectionChanged=function(f){if(!c.isMobile){return}if(c.lastSelectionChanged){clearTimeout(c.lastSelectionChanged)}c.lastSelectionChanged=setTimeout(function(){c.showPopunder(f)},300)};this.getPosition=function(){var f=window.pageXOffset!==undefined;var g=((document.compatMode||"")==="CSS1Compat");var e=f?window.pageXOffset:g?document.documentElement.scrollLeft:document.body.scrollLeft;var h=f?window.pageYOffset:g?document.documentElement.scrollTop:document.body.scrollTop;return{x:e,y:h}};this.render();if(d.elements){this.setElements(d.elements)}};b.fn.selectionSharer=function(){var c=new a();c.setElements(this);return this};if(typeof define=="function"){define(function(){a.load=function(d,g,f,c){var e=new a();e.setElements("p");f()};return a})}else{window.SelectionSharer=a}})(jQuery);